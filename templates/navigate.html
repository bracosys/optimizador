<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navegación: {{ map_data.name }} - Optimización de Rutas</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .nav-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .nav-header {
            background-color: #4a90e2;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .nav-title {
            margin: 0;
            font-size: 1.2rem;
        }
        #map-navigation {
            flex-grow: 1;
            z-index: 0;
        }
        .nav-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .btn-complete {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        .btn-back {
            background-color: white;
            color: #4a90e2;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
        }
        .stat-box {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            width: 200px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .location-status {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        .following-route {
            color: green;
        }
        .off-route {
            color: red;
        }
        /* Estilos para el modal de selección de vehículo */
        .vehicle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .vehicle-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }
        .vehicle-modal h3 {
            margin-top: 0;
            color: #4a90e2;
            text-align: center;
        }
        .vehicle-select {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .btn-select-vehicle {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Modal de selección de vehículo -->
    <div id="vehicle-modal" class="vehicle-modal">
        <div class="vehicle-modal-content">
            <h3>Selecciona el vehículo para este recorrido</h3>
            <select id="vehicle-select" class="vehicle-select">
                <option value="">-- Selecciona un vehículo --</option>
                {% for vehicle in vehicles %}
                    <option value="{{ vehicle.id }}">{{ vehicle.marca }} {{ vehicle.modelo }} ({{ vehicle.year }})</option>
                {% endfor %}
            </select>
            <button id="btn-start-navigation" class="btn-select-vehicle">Iniciar Navegación</button>
        </div>
    </div>

    <div class="nav-container">
        <div class="nav-header">
            <a href="{{ url_for('view_map', map_id=map_data.id) }}" class="btn-back">← Volver</a>
            <h2 class="nav-title">Navegando: {{ map_data.name }}</h2>
            <span id="status-indicator">Conectando...</span>
        </div>
        
        <div id="map-navigation"></div>
        
        <div class="nav-controls">
            <div class="stat-box">
                <div id="vehicle-info">Vehículo: No seleccionado</div>
                <div id="distance">Distancia: 0.0 km</div>
                <div id="time">Tiempo: 00:00</div>
                <div id="location-status" class="location-status">Esperando GPS...</div>
            </div>
            <button id="btn-complete-route" class="btn-complete" disabled>Completar Recorrido</button>
        </div>
    </div>

    <script>
        // Variables globales
        let map, userMarker, routeLayer, route;
        let tracking = false;
        let trackData = [];
        let startTime = null;
        let watchId = null;
        let selectedVehicle = "";
        const mapId = "{{ map_data.id }}";
        
        // Referencias a elementos del DOM
        const vehicleModal = document.getElementById('vehicle-modal');
        const btnStartNavigation = document.getElementById('btn-start-navigation');
        const vehicleSelect = document.getElementById('vehicle-select');
        const vehicleInfo = document.getElementById('vehicle-info');
        const btnCompleteRoute = document.getElementById('btn-complete-route');
        
        // Inicializar el mapa
        function initMap() {
            // Crear el mapa pero no iniciar navegación hasta seleccionar vehículo
            map = L.map('map-navigation').setView([0, 0], 14);
            
            // Añadir capa base del mapa
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Cargar el mapa guardado
            loadRouteData();
            
            // Marcador de usuario (posición actual)
            userMarker = L.marker([0, 0], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    shadowSize: [41, 41]
                })
            });
            
            // Configurar botón de completar recorrido
            btnCompleteRoute.addEventListener('click', completeRoute);
            
            // Configurar evento para selección de vehículo
            btnStartNavigation.addEventListener('click', function() {
                selectedVehicle = vehicleSelect.value;
                if (!selectedVehicle) {
                    alert('Por favor selecciona un vehículo para continuar');
                    return;
                }
                
                // Obtener el texto del vehículo seleccionado para mostrar en la UI
                const selectedText = vehicleSelect.options[vehicleSelect.selectedIndex].text;
                
                // Actualizar UI con el vehículo seleccionado
                vehicleInfo.textContent = 'Vehículo: ' + selectedText;
                
                // Cerrar modal
                vehicleModal.style.display = 'none';
                
                // Iniciar seguimiento de posición
                startTracking();
                
                // Habilitar botón de completar recorrido
                btnCompleteRoute.disabled = false;
            });
        }
        
        // Cargar datos de la ruta desde el iframe generado por Folium
        function loadRouteData() {
            // Usamos fetch para obtener el HTML del mapa generado
            fetch('/maps/{{ map_data.filename }}')
                .then(response => response.text())
                .then(html => {
                    // Extraer las coordenadas de polyline del HTML
                    const polylineMatch = html.match(/var\s+poly_line_[a-f0-9]+\s+=\s+L\.polyline\(\s*(\[.*?\])/s);
                    
                    if (polylineMatch && polylineMatch[1]) {
                        try {
                            // Parsear las coordenadas (esto es aproximado, podría necesitar ajustes)
                            route = JSON.parse(polylineMatch[1].replace(/'/g, '"'));
                            
                            // Dibujar la ruta en el mapa
                            routeLayer = L.polyline(route, {
                                color: 'blue',
                                weight: 5,
                                opacity: 0.7
                            }).addTo(map);
                            
                            // Centrar el mapa en la ruta
                            map.fitBounds(routeLayer.getBounds());
                            
                            // Añadir marcadores de inicio y fin
                            L.marker(route[0], {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34],
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                    shadowSize: [41, 41]
                                })
                            }).addTo(map).bindPopup('Inicio');
                            
                            L.marker(route[route.length - 1], {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34],
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                                    shadowSize: [41, 41]
                                })
                            }).addTo(map).bindPopup('Fin');
                            
                            document.getElementById('status-indicator').textContent = 'Ruta cargada';
                        } catch (e) {
                            console.error('Error al parsear las coordenadas de la ruta:', e);
                            document.getElementById('status-indicator').textContent = 'Error al cargar la ruta';
                        }
                    } else {
                        console.error('No se encontraron datos de la polyline en el HTML');
                        document.getElementById('status-indicator').textContent = 'Error al cargar la ruta';
                    }
                })
                .catch(error => {
                    console.error('Error al cargar el archivo de ruta:', error);
                    document.getElementById('status-indicator').textContent = 'Error al cargar la ruta';
                });
        }
        
        // Iniciar seguimiento de ubicación
        function startTracking() {
            if (navigator.geolocation) {
                startTime = new Date();
                updateTimer();
                
                // Actualizar posición cada 5 segundos o 10 metros de movimiento
                watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                
                tracking = true;
                document.getElementById('status-indicator').textContent = 'Navegando';
            } else {
                document.getElementById('location-status').textContent = 'Geolocalización no disponible';
                document.getElementById('status-indicator').textContent = 'Error GPS';
            }
        }
        
        // Actualizar posición del usuario
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const timestamp = position.timestamp;
            
            // Añadir punto a los datos de seguimiento
            trackData.push({
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                timestamp: timestamp
            });
            
            // Actualizar marcador de posición
            if (!userMarker._map) {
                userMarker.addTo(map);
            }
            userMarker.setLatLng([lat, lng]);
            
            // Centrar mapa en la posición actual
            map.setView([lat, lng], map.getZoom());
            
            // Comprobar si estamos en la ruta
            if (route && route.length > 0) {
                const onRoute = isOnRoute([lat, lng], route);
                const statusEl = document.getElementById('location-status');
                
                if (onRoute) {
                    statusEl.textContent = 'Siguiendo la ruta';
                    statusEl.className = 'location-status following-route';
                } else {
                    statusEl.textContent = 'Fuera de la ruta';
                    statusEl.className = 'location-status off-route';
                }
                
                // Actualizar distancia recorrida
                updateDistance();
            }
        }
        
        // Manejar errores de geolocalización
        function handleLocationError(error) {
            console.error('Error de geolocalización:', error);
            document.getElementById('location-status').textContent = 'Error: ' + error.message;
            document.getElementById('status-indicator').textContent = 'Error GPS';
        }
        
        // Comprobar si un punto está en la ruta
        function isOnRoute(point, routePoints, toleranceMeters = 50) {
            // Función para calcular distancia en metros entre dos puntos
            function distance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Radio de la Tierra en metros
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            // Comprobar distancia al segmento de ruta más cercano
            for (let i = 0; i < routePoints.length - 1; i++) {
                const d1 = distance(point[0], point[1], routePoints[i][0], routePoints[i][1]);
                if (d1 <= toleranceMeters) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Actualizar distancia total recorrida
        function updateDistance() {
            let totalDistance = 0;
            
            // Calcular distancia entre puntos de seguimiento
            for (let i = 1; i < trackData.length; i++) {
                const prevPoint = trackData[i-1];
                const currentPoint = trackData[i];
                
                function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                    const R = 6371; // Radio de la Tierra en km
                    const dLat = deg2rad(lat2 - lat1);
                    const dLon = deg2rad(lon2 - lon1);
                    const a = 
                        Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                        Math.sin(dLon/2) * Math.sin(dLon/2); 
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }
                
                function deg2rad(deg) {
                    return deg * (Math.PI/180);
                }
                
                const segmentDistance = getDistanceFromLatLonInKm(
                    prevPoint.lat, prevPoint.lng,
                    currentPoint.lat, currentPoint.lng
                );
                
                totalDistance += segmentDistance;
            }
            
            document.getElementById('distance').textContent = `Distancia: ${totalDistance.toFixed(2)} km`;
        }
        
        // Actualizar cronómetro
        function updateTimer() {
            if (!startTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            
            document.getElementById('time').textContent = `Tiempo: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            setTimeout(updateTimer, 1000);
        }
        
        // Completar recorrido
        function completeRoute() {
            if (!tracking || trackData.length === 0) {
                alert('No hay datos de seguimiento para completar el recorrido');
                return;
            }
            
            // Detener seguimiento
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Preparar datos para enviar al servidor
            const routeData = {
                trackPoints: trackData,
                totalTime: Math.floor((new Date() - startTime) / 1000),
                completedAt: new Date().toISOString()
            };
            
            // Enviar datos al servidor
            fetch(`/complete_route/${mapId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    route_data: routeData,
                    vehicle_id: selectedVehicle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('¡Recorrido completado con éxito!');
                    window.location.href = `/completed_routes`;
                } else {
                    alert('Error al guardar el recorrido: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error al completar el recorrido:', error);
                alert('Error al completar el recorrido. Por favor, inténtalo de nuevo.');
            });
        }
        
        // Inicializar el mapa cuando se cargue la página
        window.onload = initMap;
    </script>
</body>
</html>