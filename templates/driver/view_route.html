{% extends "base.html" %}

{% block title %}Ver Ruta: {{ route.name }} - Sistema de Optimización de Rutas{% endblock %}

{% block page_title %}Ver Ruta: {{ route.name }}{% endblock %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('driver_dashboard') }}" class="nav-link">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('driver_route_history') }}" class="nav-link">
        <i class="fas fa-history me-2"></i> Historial de rutas
    </a>
</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Información de la Ruta</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Nombre:</strong> {{ route.name }}
                </div>
                {% if route.description %}
                <div class="mb-3">
                    <strong>Descripción:</strong> {{ route.description }}
                </div>
                {% endif %}
                <div class="mb-3">
                    <strong>Fecha de creación:</strong> {{ route.created_at|datetime_format }}
                </div>
                <div class="mb-3">
                    <strong>Creado por:</strong> {{ route.creator.first_name }} {{ route.creator.last_name }}
                </div>
                <div class="mb-3">
                    <strong>Distancia total:</strong> {{ route.distance|distance_format }}
                </div>
                
                {% if in_progress %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i> Ya tienes una ruta en progreso.
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('driver.navigate', route_id=in_progress.route.id) }}" class="btn btn-warning">
                        <i class="fas fa-map-marked-alt me-2"></i> Continuar ruta actual
                    </a>
                </div>
                {% else %}
                <div class="d-grid gap-2">
                    <button id="startRouteBtn" class="btn btn-success" {% if not current_user.driver_info or not current_user.driver_info.vehicles %}disabled{% endif %}>
                        <i class="fas fa-play me-2"></i> Iniciar ruta
                    </button>
                </div>
                {% if not current_user.driver_info or not current_user.driver_info.vehicles %}
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i> Necesitas tener un vehículo asignado para iniciar una ruta.
                </div>
                {% endif %}
                {% endif %}
                
                <div class="d-grid gap-2 mt-3">
                    <a href="{{ url_for('driver_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Mapa de la Ruta</h6>
            </div>
            <div class="card-body p-0">
                <div id="route-map" style="height: 600px; border-radius: 0 0 4px 4px;">
                    {{ map_html|safe }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Manejar clic en botón de iniciar ruta
        $('#startRouteBtn').click(function() {
            if (confirm('¿Estás seguro de que deseas iniciar esta ruta?')) {
                $.ajax({
                    url: '/driver/start_route/{{ route.id }}',
                    type: 'POST',
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = '/driver/navigate/{{ route.id }}';
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Ha ocurrido un error al iniciar la ruta';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.message) {
                                errorMessage = response.message;
                            }
                        } catch (e) {}
                        alert('Error: ' + errorMessage);
                    }
                });
            }
        });
    });
</script>
{% endblock %}